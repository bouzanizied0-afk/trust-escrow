<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUP ULTIMATE | ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ≥ŸäÿßÿØŸä</title>
    <style>
        :root { --neon-blue: #00f2ff; --neon-green: #00ff41; --neon-red: #ff3131; --dark-bg: #050505; --panel-bg: #0a0a0f; }
        body { background: var(--dark-bg); color: white; font-family: 'Courier New', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .status-bar { width: 100%; max-width: 1200px; background: var(--panel-bg); border: 1px solid #1a1a2e; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .conn-indicator { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: var(--neon-red); box-shadow: 0 0 10px var(--neon-red); transition: 0.5s; }
        .dot.online { background: var(--neon-green); box-shadow: 0 0 15px var(--neon-green); }
        .main-grid { display: grid; grid-template-columns: 1fr 350px; gap: 20px; width: 100%; max-width: 1200px; margin-top: 20px; }
        .screen-container { background: #000; border: 2px solid #1a1a1a; height: 500px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 8px; }
        #displayScreen, #videoScreen { max-width: 100%; max-height: 100%; display: none; z-index: 2; position: relative; }
        #radarCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.5; z-index: 1; background: #000; }
        .side-panel { display: flex; flex-direction: column; gap: 20px; }
        .chat-box { background: var(--panel-bg); border: 1px solid #1a1a2e; height: 350px; display: flex; flex-direction: column; border-radius: 8px; }
        #messages { flex-grow: 1; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; color: #00f2ff; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 12px; border: 2px solid var(--neon-blue); background: transparent; color: var(--neon-blue); cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn:hover { background: var(--neon-blue); color: #000; }
        #progressBar { width: 0%; height: 5px; background: var(--neon-green); transition: 0.3s; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div>
            <span style="color: var(--neon-blue); font-weight: bold;">QUP ULTIMATE CONSOLE</span>
            <div id="tickDisplay" style="font-size: 0.7rem; color: #555;">WAITING FOR DATA...</div>
        </div>
        <div class="conn-indicator">
            <span id="connText">OFFLINE</span>
            <div id="connDot" class="dot"></div>
        </div>
        <div style="text-align: center;">
            <div id="progressStatus" style="color: var(--neon-green); font-weight: bold;">0%</div>
            <div id="progressBar"></div>
        </div>
    </div>

    <div class="main-grid">
        <div class="screen-container">
            <canvas id="radarCanvas"></canvas>
            <img id="displayScreen">
            <video id="videoScreen" controls autoplay muted></video>
            <div id="placeholder" style="color: #111; font-size: 4rem; font-weight: 900; position: absolute;">QUP TV</div>
        </div>

        <div class="side-panel">
            <div class="chat-box">
                <div id="messages"></div>
            </div>
            <div class="controls">
                <button class="btn" onclick="document.getElementById('fileInput').click()">üìÇ ÿßÿÆÿ™Ÿäÿßÿ±</button>
                <input type="file" id="fileInput" style="display: none">
                <button id="sendBtn" class="btn" style="border-color: var(--neon-green); color: var(--neon-green);">üöÄ ÿ•ÿ±ÿ≥ÿßŸÑ</button>
                <button id="clearBtn" class="btn" style="border-color: var(--neon-red); color: var(--neon-red);">üßπ ÿ≠ÿ∞ŸÅ</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ Firebase ÿ®ŸÜŸÅÿ≥ ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ™Ÿä ŸÜÿ¨ÿ≠ÿ™ ŸÅŸä ŸÖŸÑŸÅŸÉ ÿßŸÑŸÇÿØŸäŸÖ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿØŸÖÿ¨ÿ© (ÿ•ÿπÿØÿßÿØÿßÿ™ŸÉ ÿßŸÑŸÜÿßÿ¨ÿ≠ÿ© + ŸÖÿ≥ÿßÿ± ÿßŸÑÿ™ÿØŸÅŸÇ)
        const firebaseConfig = {
            apiKey: "AIzaSyAZs0bb_t-bzMtaJqy_W_QDBSdQKHLEiD4",
            authDomain: "ziedzizou-7b74d.firebaseapp.com",
            databaseURL: "https://ziedzizou-7b74d-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ziedzizou-7b74d",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const streamRef = ref(db, 'QUP_UNIVERSAL_STREAM');

        // ÿ™ÿ¨ŸáŸäÿ≤ ÿßŸÑÿ¨ÿ≥ÿ± ŸÑŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿ©
        window.fbSet = (path, data) => set(path, data);
        window.streamRef = streamRef;

        // 1. ŸÅÿ≠ÿµ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿßŸÑŸÅŸàÿ±Ÿä
        onValue(ref(db, '.info/connected'), (snap) => {
            const dot = document.getElementById('connDot');
            const txt = document.getElementById('connText');
            if (snap.val() === true) {
                dot.classList.add('online');
                txt.innerText = "ONLINE";
                txt.style.color = "var(--neon-green)";
                logToChat("‚úÖ ÿ™ŸÖ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÜÿÆÿßÿπ ÿßŸÑÿ¥ŸàŸÉŸä ŸÑŸÅŸäÿ±ÿ®ÿßÿ≥");
            } else {
                dot.classList.remove('online');
                txt.innerText = "OFFLINE";
                txt.style.color = "var(--neon-red)";
            }
        });

        // 2. ÿØŸàÿßŸÑ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        window.updateProgressPulse = (ratio) => {
            const p = Math.floor(ratio * 100);
            document.getElementById('progressBar').style.width = p + "%";
            document.getElementById('progressStatus').innerText = p + "%";
        };

        window.updateRotaryVisual = (tick) => {
            document.getElementById('tickDisplay').innerText = `TICK: ${tick}`;
        };

        function logToChat(msg) {
            const m = document.getElementById('messages');
            m.innerHTML += `<div>> ${msg}</div>`;
            m.scrollTop = m.scrollHeight;
        }
        window.logToChat = logToChat;

        // 3. ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ±ÿßÿØÿßÿ± (Canvas)
        const canvas = document.getElementById('radarCanvas');
        const ctx = canvas.getContext('2d');
        window.drawToCanvas = (buffer) => {
            const size = Math.ceil(Math.sqrt(buffer.length / 4)) || 256;
            if(canvas.width !== size) canvas.width = canvas.height = size;
            const imgData = new ImageData(new Uint8ClampedArray(buffer.buffer), size, size);
            ctx.putImageData(imgData, 0, 0);
        };

        // 4. ÿßŸÑÿ±ÿ®ÿ∑ ŸÖÿπ ŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ∑Ÿàÿ± (ÿßŸÑŸÖÿ≠ÿ±ŸÉ ŸàÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ)
        import { QUP_Core } from './QUP_Core.js';
        
        document.getElementById('sendBtn').onclick = () => {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                logToChat(`üöÄ ÿ®ÿØÿ° ÿ™ÿ¥ŸÅŸäÿ± Ÿàÿ•ÿ±ÿ≥ÿßŸÑ: ${file.name}`);
                QUP_Core.transmit(file);
            }
        };

        document.getElementById('clearBtn').onclick = () => {
            remove(streamRef).then(() => {
                logToChat("üßπ ÿ™ŸÖ ÿ™ÿ∑ŸáŸäÿ± ÿßŸÑŸÖÿ≥ÿßÿ± ÿßŸÑÿπÿßŸÑŸÖŸä");
                setTimeout(() => location.reload(), 1000);
            });
        };

        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const isVideo = file.type.startsWith('video/');
                document.getElementById('displayScreen').style.display = isVideo ? 'none' : 'block';
                document.getElementById('videoScreen').style.display = isVideo ? 'block' : 'none';
                document.getElementById('placeholder').style.display = 'none';
                if(!isVideo) document.getElementById('displayScreen').src = URL.createObjectURL(file);
                logToChat(`üìÅ ŸÖŸÑŸÅ ÿ¨ÿßŸáÿ≤: ${file.name}`);
            }
        };
    </script>

    <script type="module" src="QUP_Receiver_Ultimate.js"></script>

</body>
</html>

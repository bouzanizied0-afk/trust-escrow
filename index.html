<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>QUP Command Center - Sovereign Edition</title>
    <style>
        body {
            margin: 0; background-color: #050505; color: #2ecc71;
            font-family: 'Courier New', monospace;
            display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden;
        }
        /* Ø§Ù„Ù…ØµØ§Ø¨ÙŠØ­ Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .status-bar {
            width: 100%; padding: 10px; background: #111;
            display: flex; justify-content: center; align-items: center; gap: 30px;
            border-bottom: 2px solid #222; font-size: 0.8rem;
        }
        .status-item { display: flex; align-items: center; gap: 8px; }
        .led { width: 12px; height: 12px; border-radius: 50%; background: grey; transition: 0.5s; }
        
        #main-counter {
            font-size: 5rem; font-weight: bold; margin: 10px 0;
            text-shadow: 0 0 20px #2ecc71; color: #39ff14;
        }
        .container {
            display: grid; grid-template-columns: 1fr 380px;
            gap: 15px; width: 98%; height: 75vh;
        }
        /* Ø§Ù„Ø´Ø§Ø´Ø© */
        .display-unit {
            background: #000; border: 2px solid #2ecc71; position: relative;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        #radar-canvas { position: absolute; width: 100%; height: 100%; opacity: 0.3; z-index: 1; }
        #tv-image, #tv-video { max-width: 95%; max-height: 95%; display: none; z-index: 5; border: 1px solid #2ecc71; }

        /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .panel { display: flex; flex-direction: column; gap: 10px; height: 100%; }
        #chat-box {
            flex-grow: 1; background: rgba(0,15,0,0.9); border: 1px solid #2ecc71;
            padding: 10px; font-size: 0.85rem; overflow-y: auto; color: #39ff14;
        }
        .chat-input-area { display: flex; gap: 5px; }
        #chatInput { 
            flex-grow: 1; background: #000; border: 1px solid #2ecc71; color: #39ff14; padding: 8px; outline: none;
        }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        button {
            padding: 12px; cursor: pointer; border: none; font-weight: bold;
            background: #2ecc71; color: #000;
        }
        .btn-send-chat { padding: 8px 15px; }
        .btn-danger { background: #e74c3c; color: white; margin-top: auto; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div class="status-item">
            <div id="led-fb" class="led"></div> <span>FIREBASE</span>
        </div>
        <div class="status-item">
            <div id="led-core" class="led"></div> <span>QUP_CORE</span>
        </div>
        <div class="status-item">
            <div id="led-rcv" class="led"></div> <span>RECEIVER</span>
        </div>
    </div>

    <div id="main-counter">000000</div>

    <div class="container">
        <div class="display-unit">
            <canvas id="radar-canvas"></canvas>
            <img id="tv-image">
            <video id="tv-video" controls autoplay></video>
            <div id="placeholder" style="color:#111; z-index:0">SYSTEM READY</div>
        </div>

        <div class="panel">
            <div id="chat-box">>> Ù†Ø¸Ø§Ù… QUP Ù…ØªØµÙ„...</div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø³Ø§Ù„ØªÙƒ...">
                <button id="sendMsgBtn" class="btn-send-chat">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
            
            <input type="file" id="fileInput" style="display: none;">
            <div class="btn-group">
                <button onclick="document.getElementById('fileInput').click()">ğŸ“‚ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</button>
                <button id="sendBtn" style="background: #39ff14;">ğŸš€ Ø¨Ø« Ø§Ù„Ù†Ø¨Ø¶Ø©</button>
            </div>
            <button class="btn-danger" id="clearBtn">ğŸ’€ ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø³Ø­Ø§Ø¨</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAZs0bb_t-bzMtaJqy_W_QDBSdQKHLEiD4",
            authDomain: "ziedzizou-7b74d.firebaseapp.com",
            databaseURL: "https://ziedzizou-7b74d-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ziedzizou-7b74d",
            storageBucket: "ziedzizou-7b74d.firebasestorage.app",
            messagingSenderId: "937969676323",
            appId: "1:937969676323:web:8c89472de068a2e6cd0196",
            measurementId: "G-WQR9DXYGPS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const streamRef = ref(db, 'QUP_UNIVERSAL_STREAM');
        const chatRef = ref(db, 'QUP_CHAT');

        const ledFb = document.getElementById('led-fb');
        const ledCore = document.getElementById('led-core');
        const ledRcv = document.getElementById('led-rcv');
        const counter = document.getElementById('main-counter');
        const chatBox = document.getElementById('chat-box');

        // --- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª ---
        onValue(ref(db, ".info/connected"), (snap) => {
            if (snap.val() === true) {
                ledFb.style.backgroundColor = "#2ecc71";
                ledFb.style.boxShadow = "0 0 10px #2ecc71";
                // Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ ÙÙŠØ±Ø¨Ø§ÙŠØ³ØŒ Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡
                ledCore.style.backgroundColor = "#3498db";
                ledRcv.style.backgroundColor = "#3498db";
                addToChat("SYS", "Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¬Ø§Ù‡Ø².");
            }
        });

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
        document.getElementById('sendMsgBtn').onclick = sendMessage;
        document.getElementById('chatInput').onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

        function sendMessage() {
            const msg = document.getElementById('chatInput').value;
            if(msg) {
                push(chatRef, { user: "USER", text: msg, time: Date.now() });
                document.getElementById('chatInput').value = "";
            }
        }

        onValue(chatRef, (snap) => {
            chatBox.innerHTML = "";
            snap.forEach(child => {
                const data = child.val();
                addToChat(data.user, data.text);
            });
        });

        function addToChat(user, msg) {
            chatBox.innerHTML += `<div><span style="color:#888">[${user}]:</span> ${msg}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø§Ù„Ù…Ø±Ø³Ù„) ---
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ù…Ø±Ø³Ù„
                const url = URL.createObjectURL(file);
                const isVideo = file.type.startsWith('video/');
                document.getElementById('tv-image').src = url;
                document.getElementById('tv-image').style.display = isVideo ? 'none' : 'block';
                document.getElementById('tv-video').style.display = isVideo ? 'block' : 'none';
                if(isVideo) document.getElementById('tv-video').src = url;
                addToChat("CORE", `ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù„Ù: ${file.name}`);
            }
        };

        const QUP_Core = {
            async transmit(file) {
                ledCore.style.backgroundColor = "#39ff14";
                const rawData = new Uint8Array(await file.arrayBuffer());
                await set(streamRef, { t: 'GENESIS', name: file.name, size: rawData.length, sid: Date.now() });
                
                for (let i = 0; i < rawData.length; i += 1000) {
                    counter.innerText = i.toString().padStart(6, '0');
                    await set(streamRef, { d: `${i}:${rawData[i]}`, t: 'DATA' });
                }
                await set(streamRef, { t: 'TERMINATE' });
                ledCore.style.backgroundColor = "#3498db";
            }
        };

        // --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ (Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„) ---
        onValue(streamRef, (snap) => {
            const data = snap.val();
            if (!data) return;
            ledRcv.style.backgroundColor = "#39ff14";
            if (data.t === 'DATA') {
                counter.innerText = data.d.split(':')[0].padStart(6, '0');
                drawRadar();
            }
            if (data.t === 'TERMINATE') ledRcv.style.backgroundColor = "#3498db";
        });

        function drawRadar() {
            const canvas = document.getElementById('radar-canvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "rgba(57, 255, 20, 0.2)";
            ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 3, 3);
        }

        document.getElementById('sendBtn').onclick = () => {
            const file = document.getElementById('fileInput').files[0];
            if (file) QUP_Core.transmit(file);
        };

        document.getElementById('clearBtn').onclick = () => {
            remove(streamRef);
            remove(chatRef);
            location.reload();
        };

    </script>
</body>
</html>

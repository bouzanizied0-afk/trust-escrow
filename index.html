<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUP SOVEREIGN CONSOLE</title>
    <style>
        :root {
            --neon-blue: #00f2ff; --neon-green: #00ff41; --neon-red: #ff3131;
            --dark-bg: #050505; --panel-bg: #0a0a0f;
        }
        body { background: var(--dark-bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø­ØªØ±Ø§ÙÙŠ */
        .status-bar { width: 100%; max-width: 1200px; background: var(--panel-bg); border: 1px solid #1a1a2e; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .conn-indicator { display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: var(--neon-red); box-shadow: 0 0 10px var(--neon-red); }
        .dot.online { background: var(--neon-green); box-shadow: 0 0 15px var(--neon-green); }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªÙ„ÙØ§Ø² + Ø±Ø§Ø¯Ø§Ø±) */
        .main-grid { display: grid; grid-template-columns: 1fr 350px; gap: 20px; width: 100%; max-width: 1200px; margin-top: 20px; }
        
        .screen-container { background: #000; border: 2px solid #1a1a1a; height: 500px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 8px; }
        #displayScreen, #videoScreen { max-width: 100%; max-height: 100%; display: none; z-index: 2; }
        
        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø§Ø¯Ø§Ø± (Canvas) Ø®Ù„Ù Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ */
        #radarCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.4; z-index: 1; }

        .side-panel { display: flex; flex-direction: column; gap: 20px; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .chat-box { background: var(--panel-bg); border: 1px solid #1a1a2e; height: 350px; display: flex; flex-direction: column; border-radius: 8px; }
        #messages { flex-grow: 1; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; color: #00f2ff; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.3s; text-transform: uppercase; }
        .btn-send { background: var(--neon-green); color: black; }
        .btn-delete { background: var(--neon-red); color: white; }
        .btn-file { background: var(--neon-blue); color: black; }
        .btn:hover { opacity: 0.8; transform: scale(0.98); }

        #progressContainer { width: 100%; height: 5px; background: #111; margin-top: 10px; border-radius: 10px; }
        #progressBar { width: 0%; height: 100%; background: var(--neon-green); transition: 0.3s; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div>
            <span style="color: var(--neon-blue); font-weight: bold;">QUP ULTIMATE CONSOLE</span>
            <div id="clockDisplay" style="font-family: monospace; font-size: 0.8rem; margin-top: 5px;">TICK: 00000000</div>
        </div>
        <div class="conn-indicator">
            <span id="connText">FIREBASE DISCONNECTED</span>
            <div id="connDot" class="dot"></div>
        </div>
        <div style="text-align: center;">
            <span style="font-size: 0.7rem; color: #555;">BUFFER LOAD</span>
            <div id="progressStatus" style="color: var(--neon-green); font-weight: bold;">0%</div>
        </div>
    </div>

    <div class="main-grid">
        <div class="screen-container">
            <canvas id="radarCanvas"></canvas> <img id="displayScreen"> <video id="videoScreen" controls autoplay muted></video> <div id="placeholder" style="color: #222; font-size: 5rem; font-weight: 900; position: absolute;">QUP TV</div>
        </div>

        <div class="side-panel">
            <div class="chat-box">
                <div id="messages"></div>
                <div style="padding: 10px; border-top: 1px solid #1a1a2e; display: flex; gap: 5px;">
                    <input type="text" id="chatInput" placeholder="Command..." style="flex:1; background: #000; border: 1px solid #222; color: #fff; padding: 5px;">
                    <button class="btn btn-file" style="padding: 5px 10px;">ğŸ’¬</button>
                </div>
            </div>

            <div class="controls">
                <label for="fileInput" class="btn btn-file" style="text-align: center; display: block;">ğŸ“‚ Ø§Ø®ØªÙ€Ø§Ø±</label>
                <input type="file" id="fileInput" style="display: none;">
                <button id="sendBtn" class="btn btn-send">ğŸš€ Ø¥Ø±Ø³Ø§Ù„</button>
                <button id="clearBtn" class="btn btn-delete">ğŸ§¹ Ø­Ø°Ù</button>
            </div>
            <div id="progressContainer"><div id="progressBar"></div></div>
        </div>
    </div>

    <script type="module">
        import { QUP_Core } from './QUP_Core.js';
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const db = getDatabase();
        const streamRef = ref(db, 'QUP_UNIVERSAL_STREAM');

        // 1. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø­Ù…Ø±/Ø§Ù„Ø£Ø®Ø¶Ø±)
        onValue(ref(db, '.info/connected'), (snap) => {
            const dot = document.getElementById('connDot');
            const txt = document.getElementById('connText');
            if (snap.val() === true) {
                dot.classList.add('online');
                txt.innerText = "FIREBASE LINK ACTIVE";
                txt.style.color = "var(--neon-green)";
            } else {
                dot.classList.remove('online');
                txt.innerText = "LINK BROKEN";
                txt.style.color = "var(--neon-red)";
            }
        });

        // 2. Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„Ù…Ø­Ø±Ùƒ ÙˆØ§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
        window.updateProgressPulse = (ratio) => {
            const p = Math.floor(ratio * 100);
            document.getElementById('progressBar').style.width = p + "%";
            document.getElementById('progressStatus').innerText = p + "%";
        };

        window.updateRotaryVisual = (tick) => {
            document.getElementById('clockDisplay').innerText = `TICK: ${tick.toString().padStart(8, '0')}`;
        };

        window.logToChat = (msg) => {
            const m = document.getElementById('messages');
            m.innerHTML += `<div>> ${msg}</div>`;
            m.scrollTop = m.scrollHeight;
        };

        // 3. Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù„Ø­Ø¸ÙŠ: Ø±Ø³Ù… Ø§Ù„Ø¨ÙƒØ³Ù„Ø§Øª ÙÙˆØ± ÙˆØµÙˆÙ„ Ø§Ù„Ù†Ø¨Ø¶Ø§Øª
        const canvas = document.getElementById('radarCanvas');
        const ctx = canvas.getContext('2d');
        window.drawToCanvas = (buffer) => {
            if (!buffer) return;
            // Ø±Ø³Ù… Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹ Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ù„Ù
            const size = Math.sqrt(buffer.length);
            canvas.width = size || 500;
            canvas.height = size || 500;
            const imgData = ctx.createImageData(canvas.width, canvas.height);
            for (let i = 0; i < buffer.length; i++) {
                imgData.data[i * 4] = buffer[i];     // R
                imgData.data[i * 4 + 1] = buffer[i]; // G
                imgData.data[i * 4 + 2] = buffer[i]; // B
                imgData.data[i * 4 + 3] = 255;       // A
            }
            ctx.putImageData(imgData, 0, 0);
        };

        // 4. Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        document.getElementById('sendBtn').onclick = () => {
            const file = document.getElementById('fileInput').files[0];
            if (file) QUP_Core.transmit(file);
            else alert("Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹!");
        };

        document.getElementById('clearBtn').onclick = () => {
            remove(streamRef).then(() => {
                window.logToChat("ğŸš¨ ØªÙ… ØªØ·Ù‡ÙŠØ± Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙƒÙ„ÙŠØ§Ù‹.");
                location.reload();
            });
        };

        // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                const isVideo = file.type.startsWith('video/');
                document.getElementById('displayScreen').style.display = isVideo ? 'none' : 'block';
                document.getElementById('videoScreen').style.display = isVideo ? 'block' : 'none';
                if(isVideo) document.getElementById('videoScreen').src = url;
                else document.getElementById('displayScreen').src = url;
                document.getElementById('placeholder').style.display = 'none';
                window.logToChat(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„: ${file.name}`);
            }
        };
    </script>

    <script type="module" src="QUP_Core.js"></script>
    <script type="module" src="QUP_Receiver_Ultimate.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>QUP Command Center - Sovereign Edition</title>
    <style>
        body {
            margin: 0; background-color: #050505; color: #2ecc71;
            font-family: 'Courier New', monospace;
            display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden;
        }
        .status-bar {
            width: 100%; padding: 10px; background: #111;
            display: flex; justify-content: center; align-items: center; gap: 30px;
            border-bottom: 2px solid #222; font-size: 0.8rem;
        }
        .status-item { display: flex; align-items: center; gap: 8px; }
        .led { width: 12px; height: 12px; border-radius: 50%; background: #330000; transition: 0.5s; border: 1px solid #000; }
        
        #main-counter {
            font-size: 5rem; font-weight: bold; margin: 10px 0;
            text-shadow: 0 0 20px #2ecc71; color: #39ff14;
        }
        .container {
            display: grid; grid-template-columns: 1fr 380px;
            gap: 15px; width: 98%; height: 70vh;
        }
        .display-unit {
            background: #000; border: 2px solid #2ecc71; position: relative;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        #radar-canvas { position: absolute; width: 100%; height: 100%; opacity: 0.3; z-index: 1; }
        #tv-image, #tv-video { max-width: 95%; max-height: 95%; display: none; z-index: 5; border: 1px solid #2ecc71; }

        .panel { display: flex; flex-direction: column; gap: 10px; height: 100%; }
        #chat-box {
            flex-grow: 1; background: rgba(0,15,0,0.9); border: 1px solid #2ecc71;
            padding: 10px; font-size: 0.85rem; overflow-y: auto; color: #39ff14;
        }
        .chat-input-area { display: flex; gap: 5px; }
        #chatInput { 
            flex-grow: 1; background: #000; border: 1px solid #2ecc71; color: #39ff14; padding: 8px; outline: none;
        }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        button {
            padding: 12px; cursor: pointer; border: none; font-weight: bold;
            background: #2ecc71; color: #000; transition: 0.3s;
        }
        button:hover { opacity: 0.8; }
        .btn-danger { background: #e74c3c; color: white; margin-top: auto; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div class="status-item">
            <div id="led-fb" class="led"></div> <span>FIREBASE</span>
        </div>
        <div class="status-item">
            <div id="led-core" class="led"></div> <span>qup_core.js</span>
        </div>
        <div class="status-item">
            <div id="led-rcv" class="led"></div> <span>qup_receiver.js</span>
        </div>
    </div>

    <div id="main-counter">0%</div>

    <div class="container">
        <div class="display-unit">
            <canvas id="radar-canvas"></canvas>
            <img id="tv-image">
            <video id="tv-video" controls autoplay loop></video>
        </div>

        <div class="panel">
            <div id="chat-box">>> Ù†Ø¸Ø§Ù… QUP Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„...</div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø³Ø­Ø§Ø¨...">
                <button id="sendMsgBtn">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
            
            <input type="file" id="fileInput" style="display: none;">
            <div class="btn-group">
                <button id="uploadBtn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</button>
                <button id="sendBtn" style="background: #39ff14;">ğŸš€ Ø¨Ø« Ø§Ù„Ù†Ø¨Ø¶Ø©</button>
            </div>
            <button class="btn-danger" id="clearBtn">ğŸ’€ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAZs0bb_t-bzMtaJqy_W_QDBSdQKHLEiD4",
            authDomain: "ziedzizou-7b74d.firebaseapp.com",
            databaseURL: "https://ziedzizou-7b74d-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ziedzizou-7b74d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
        window.db = db;
        window.mainCounter = document.getElementById('main-counter');
        window.chatBox = document.getElementById('chat-box');

        const ledFb = document.getElementById('led-fb');
        const ledCore = document.getElementById('led-core');
        const ledRcv = document.getElementById('led-rcv');

        // 1. ÙØ­Øµ Ø§ØªØµØ§Ù„ Firebase
        onValue(ref(db, ".info/connected"), (snap) => {
            ledFb.style.background = snap.val() === true ? "#2ecc71" : "red";
            if(snap.val()) ledFb.style.boxShadow = "0 0 10px #2ecc71";
        });

        // 2. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø­Ø±Ùƒ ÙˆØ§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ÙˆØ±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        try {
            // Ø±Ø¨Ø· Ø§Ù„Ù…Ø­Ø±Ùƒ (Core)
            import('./qup_core.js').then(m => {
                ledCore.style.background = "#2ecc71";
                ledCore.style.boxShadow = "0 0 10px #2ecc71";
                window.QUP_Core = m.QUP_Core;

                // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø¨Ø« Ø§Ù„Ù†Ø¨Ø¶Ø©
                document.getElementById('sendBtn').onclick = () => {
                    const file = document.getElementById('fileInput').files[0];
                    if (file) {
                        window.chatBox.innerHTML += `<div>>> Ø¬Ø§Ø±ÙŠ Ø¨Ø«: ${file.name}...</div>`;
                        window.QUP_Core.transmit(file);
                    } else {
                        alert("Ø§Ø®ØªØ± Ù…Ù„ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ø¨Ø± Ø²Ø± (Ø±ÙØ¹ Ù…Ù„Ù)");
                    }
                };
            }).catch(() => ledCore.style.background = "red");

            // Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ (Receiver)
            import('./qup_receiver_ultimate.js').then(m => {
                ledRcv.style.background = "#2ecc71";
                ledRcv.style.boxShadow = "0 0 10px #2ecc71";
                if(m.QUP_Receiver && m.QUP_Receiver.init) m.QUP_Receiver.init();
            }).catch(() => ledRcv.style.background = "red");

        } catch(e) { console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª:", e); }

        // 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
        const chatRef = ref(db, 'QUP_CHAT');
        document.getElementById('sendMsgBtn').onclick = () => {
            const msg = document.getElementById('chatInput').value;
            if(msg) {
                set(chatRef, { text: msg, time: Date.now() });
                document.getElementById('chatInput').value = "";
            }
        };
        onValue(chatRef, (snap) => {
            const data = snap.val();
            if(data) window.chatBox.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${data.text}</div>`;
            window.chatBox.scrollTop = window.chatBox.scrollHeight;
        });

        // 4. Ø²Ø± Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ø­Ø°Ù Ø§Ù„Ø³Ø­Ø§Ø¨)
        document.getElementById('clearBtn').onclick = async () => {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø« ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø©ØŸ")) {
                await remove(ref(db, 'QUP_UNIVERSAL_STREAM'));
                await remove(ref(db, 'QUP_CHAT'));
                window.mainCounter.innerText = "0%";
                window.chatBox.innerHTML += `<div style="color:red">>> ØªÙ… ØªØ·Ù‡ÙŠØ± Ø§Ù„Ø³Ø­Ø§Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.</div>`;
            }
        };

        // 5. Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
        document.getElementById('fileInput').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                const img = document.getElementById('tv-image');
                const video = document.getElementById('tv-video');
                if (file.type.startsWith('video/')) {
                    img.style.display="none"; video.style.display="block"; video.src=url;
                } else {
                    video.style.display="none"; img.style.display="block"; img.src=url;
                }
                window.chatBox.innerHTML += `<div>>> Ù…Ù„Ù Ø¬Ø§Ù‡Ø²: ${file.name}</div>`;
            }
        };
    </script>
</body>
</html>
